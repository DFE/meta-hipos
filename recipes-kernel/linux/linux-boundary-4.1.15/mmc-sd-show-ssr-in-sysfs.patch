From 9ac2479bce8641a088c71fc02e05180a54beea95 Mon Sep 17 00:00:00 2001
From: Mario Schuknecht <mario.schuknecht@dresearch-fe.de>
Date: Tue, 29 Mar 2016 16:26:59 +0200
Subject: [PATCH] mmc: sd: show ssr in sysfs

Show raw SD card status register (ssr) in sysfs.

Signed-off-by: Mario Schuknecht <mario.schuknecht@dresearch-fe.de>
---
 drivers/mmc/core/sd.c    | 9 +++++++++
 include/linux/mmc/card.h | 1 +
 2 files changed, 10 insertions(+)

diff --git a/drivers/mmc/core/sd.c b/drivers/mmc/core/sd.c
index 569972f..483f5e2 100644
--- a/drivers/mmc/core/sd.c
+++ b/drivers/mmc/core/sd.c
@@ -248,6 +248,8 @@ static int mmc_read_ssr(struct mmc_card *card)
 	for (i = 0; i < 16; i++)
 		ssr[i] = be32_to_cpu(ssr[i]);
 
+	memcpy(card->raw_ssr, ssr, sizeof(card->raw_ssr));
+
 	/*
 	 * UNSTUFF_BITS only works with four u32s so we have to offset the
 	 * bitfield positions accordingly.
@@ -683,6 +685,12 @@ out:
 	return err;
 }
 
+MMC_DEV_ATTR(ssr, "%08x%08x%08x%08x\n%08x%08x%08x%08x\n%08x%08x%08x%08x\n"
+	"%08x%08x%08x%08x\n", card->raw_ssr[0], card->raw_ssr[1],
+	card->raw_ssr[2], card->raw_ssr[3], card->raw_ssr[4], card->raw_ssr[5],
+	card->raw_ssr[6], card->raw_ssr[7], card->raw_ssr[8], card->raw_ssr[9],
+	card->raw_ssr[10], card->raw_ssr[11], card->raw_ssr[12],
+	card->raw_ssr[13], card->raw_ssr[14], card->raw_ssr[15]);
 MMC_DEV_ATTR(cid, "%08x%08x%08x%08x\n", card->raw_cid[0], card->raw_cid[1],
 	card->raw_cid[2], card->raw_cid[3]);
 MMC_DEV_ATTR(csd, "%08x%08x%08x%08x\n", card->raw_csd[0], card->raw_csd[1],
@@ -700,6 +708,7 @@ MMC_DEV_ATTR(serial, "0x%08x\n", card->cid.serial);
 
 
 static struct attribute *sd_std_attrs[] = {
+	&dev_attr_ssr.attr,
 	&dev_attr_cid.attr,
 	&dev_attr_csd.attr,
 	&dev_attr_scr.attr,
diff --git a/include/linux/mmc/card.h b/include/linux/mmc/card.h
index 2e05a17..a9f5c72 100644
--- a/include/linux/mmc/card.h
+++ b/include/linux/mmc/card.h
@@ -287,6 +287,7 @@ struct mmc_card {
 	u32			raw_cid[4];	/* raw card CID */
 	u32			raw_csd[4];	/* raw card CSD */
 	u32			raw_scr[2];	/* raw card SCR */
+	u32			raw_ssr[16];	/* raw card SSR */
 	struct mmc_cid		cid;		/* card identification */
 	struct mmc_csd		csd;		/* card specific */
 	struct mmc_ext_csd	ext_csd;	/* mmc v4 extended card specific */
-- 
2.1.4

