From 12d54996dd1bde5cf1b44e587dd20795522de566 Mon Sep 17 00:00:00 2001
From: Steffen Sledz <sledz@dresearch-fe.de>
Date: Mon, 18 Jan 2016 15:51:56 +0100
Subject: [PATCH] hikirk: add hikirk board

Add support for hikirk board.

Signed-off-by: Steffen Sledz <sledz@dresearch-fe.de>
---
 arch/arm/include/asm/mach-types.h |   1 +
 arch/arm/mach-kirkwood/Kconfig    |   4 +
 board/Marvell/hikirk/Kconfig      |  23 ++++++
 board/Marvell/hikirk/Makefile     |  14 ++++
 board/Marvell/hikirk/hikirk.c     | 170 ++++++++++++++++++++++++++++++++++++++
 configs/hikirk_defconfig          |  47 +++++++++++
 include/configs/hikirk.h          | 156 ++++++++++++++++++++++++++++++++++
 7 files changed, 415 insertions(+)
 create mode 100644 board/Marvell/hikirk/Kconfig
 create mode 100644 board/Marvell/hikirk/Makefile
 create mode 100644 board/Marvell/hikirk/hikirk.c
 create mode 100644 configs/hikirk_defconfig
 create mode 100644 include/configs/hikirk.h

diff --git a/arch/arm/include/asm/mach-types.h b/arch/arm/include/asm/mach-types.h
index 5afe791..a2251bf 100644
--- a/arch/arm/include/asm/mach-types.h
+++ b/arch/arm/include/asm/mach-types.h
@@ -1108,6 +1108,7 @@ extern unsigned int __machine_arch_type;
 #define MACH_TYPE_KZM9G                4140
 #define MACH_TYPE_COLIBRI_T30          4493
 #define MACH_TYPE_APALIS_T30           4513
+#define MACH_TYPE_HIKIRK               4745
 #define MACH_TYPE_OMAPL138_LCDK        2495
 
 #ifdef CONFIG_ARCH_EBSA110
diff --git a/arch/arm/mach-kirkwood/Kconfig b/arch/arm/mach-kirkwood/Kconfig
index 1261885..1a529d4 100644
--- a/arch/arm/mach-kirkwood/Kconfig
+++ b/arch/arm/mach-kirkwood/Kconfig
@@ -4,6 +4,9 @@ choice
 	prompt "Marvell Kirkwood board select"
 	optional
 
+config TARGET_HIKIRK
+	bool "DResearch hikirk Board"
+
 config TARGET_OPENRD
 	bool "Marvell OpenRD Board"
 
@@ -66,6 +69,7 @@ endchoice
 config SYS_SOC
 	default "kirkwood"
 
+source "board/Marvell/hikirk/Kconfig"
 source "board/Marvell/openrd/Kconfig"
 source "board/Marvell/mv88f6281gtw_ge/Kconfig"
 source "board/Marvell/rd6281a/Kconfig"
diff --git a/board/Marvell/hikirk/Kconfig b/board/Marvell/hikirk/Kconfig
new file mode 100644
index 0000000..0d7b8d7
--- /dev/null
+++ b/board/Marvell/hikirk/Kconfig
@@ -0,0 +1,23 @@
+if TARGET_HIKIRK
+
+config SYS_CPU
+	string
+	default "arm926ejs"
+
+config SYS_BOARD
+	string
+	default "hikirk"
+
+config SYS_VENDOR
+	string
+	default "Marvell"
+
+config SYS_SOC
+	string
+	default "kirkwood"
+
+config SYS_CONFIG_NAME
+	string
+	default "hikirk"
+
+endif
diff --git a/board/Marvell/hikirk/Makefile b/board/Marvell/hikirk/Makefile
new file mode 100644
index 0000000..f323ab8
--- /dev/null
+++ b/board/Marvell/hikirk/Makefile
@@ -0,0 +1,14 @@
+#
+# (C) Copyright 2009
+# Net Insight <www.netinsight.net>
+# Written-by: Simon Kagstrom <simon.kagstrom@netinsight.net>
+#
+# Based on sheevaplug:
+# (C) Copyright 2009
+# Marvell Semiconductor <www.marvell.com>
+# Written-by: Prafulla Wadaskar <prafulla@marvell.com>
+#
+# SPDX-License-Identifier:	GPL-2.0+
+#
+
+obj-y	:= hikirk.o
diff --git a/board/Marvell/hikirk/hikirk.c b/board/Marvell/hikirk/hikirk.c
new file mode 100644
index 0000000..cd484a0
--- /dev/null
+++ b/board/Marvell/hikirk/hikirk.c
@@ -0,0 +1,170 @@
+/*
+ * Based on openrd.c:
+ * (C) Copyright 2009
+ * Net Insight <www.netinsight.net>
+ * Written-by: Simon Kagstrom <simon.kagstrom@netinsight.net>
+ *
+ * Based on sheevaplug.c:
+ * (C) Copyright 2009
+ * Marvell Semiconductor <www.marvell.com>
+ * Written-by: Prafulla Wadaskar <prafulla@marvell.com>
+ *
+ * See file CREDITS for list of people who contributed to this
+ * project.
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License as
+ * published by the Free Software Foundation; either version 2 of
+ * the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+ * MA 02110-1301 USA
+ */
+
+#include <common.h>
+#include <miiphy.h>
+#include <asm/arch/cpu.h>
+#include <asm/arch/soc.h>
+#include <asm/arch/mpp.h>
+
+#define HIKIRK_OE_LOW		(~(1<<28))        /* RS232 / RS485 */
+#define HIKIRK_OE_HIGH		(~(1<<2))         /* SD / UART1 */
+#define HIKIRK_OE_VAL_LOW		(0)       /* Sel RS232 */
+#define HIKIRK_OE_VAL_HIGH		(1 << 2)  /* Sel SD */
+
+DECLARE_GLOBAL_DATA_PTR;
+
+int board_early_init_f(void)
+{
+	/*
+	 * default gpio configuration
+	 * There are maximum 64 gpios controlled through 2 sets of registers
+	 * the  below configuration configures mainly initial LED status
+	 */
+	mvebu_config_gpio(HIKIRK_OE_VAL_LOW,
+			HIKIRK_OE_VAL_HIGH,
+			HIKIRK_OE_LOW, HIKIRK_OE_HIGH);
+
+	/* Multi-Purpose Pins Functionality configuration */
+	static const u32 kwmpp_config[] = {
+		MPP0_SPI_SCn,
+		MPP1_SPI_MOSI,
+		MPP2_SPI_SCK,
+		MPP3_SPI_MISO,
+		MPP4_UART0_RXD,
+		MPP5_UART0_TXD,
+		MPP6_SYSRST_OUTn,
+		MPP7_GPO,
+		MPP8_TW_SDA,
+		MPP9_TW_SCK,
+		MPP10_GPO,
+		MPP11_GPIO,
+		MPP12_SD_CLK,
+		MPP13_SD_CMD, /* Alt UART1_TXD */
+		MPP14_SD_D0,  /* Alt UART1_RXD */
+		MPP15_SD_D1,
+		MPP16_SD_D2,
+		MPP17_SD_D3,
+		MPP18_GPO,
+		MPP19_GPO,
+		MPP20_GE1_0,
+		MPP21_GE1_1,
+		MPP22_GE1_2,
+		MPP23_GE1_3,
+		MPP24_GE1_4,
+		MPP25_GE1_5,
+		MPP26_GE1_6,
+		MPP27_GE1_7,
+		MPP28_GPIO,
+		MPP29_TSMP9,
+		MPP30_GE1_10,
+		MPP31_GE1_11,
+		MPP32_GE1_12,
+		MPP33_GE1_13,
+		MPP34_GPIO,   /* UART1 / SD sel */
+		MPP35_GPIO,
+		MPP36_GPIO,
+		MPP37_GPIO,
+		MPP38_GPIO,
+		MPP39_AUDIO_I2SBCLK,
+		MPP40_AUDIO_I2SDO,
+		MPP41_AUDIO_I2SLRC,
+		MPP42_AUDIO_I2SMCLK,
+		MPP43_AUDIO_I2SDI,
+		MPP44_AUDIO_EXTCLK,
+		MPP45_TDM_PCLK,
+		MPP46_TDM_FS,
+		MPP47_TDM_DRX,
+		MPP48_TDM_DTX,
+		MPP49_TDM_CH0_RX_QL,
+		0
+	};
+
+	kirkwood_mpp_conf(kwmpp_config, NULL);
+	return 0;
+}
+
+int board_init(void)
+{
+	/*
+	 * arch number of board
+	 */
+	gd->bd->bi_arch_number = MACH_TYPE_HIKIRK;
+
+	/* adress of boot parameters */
+	gd->bd->bi_boot_params = mvebu_sdram_bar(0) + 0x100;
+	return 0;
+}
+
+#ifdef CONFIG_RESET_PHY_R
+
+#define KSZ9031RNX_MMD_CTRL_REG 0xd
+#define KSZ9031RNX_MMD_DATA_REG 0xe
+/* Configure and enable MV88E1116/88E1121 PHY */
+void mv_phy_init(char *name)
+{
+	u16 reg;
+	u16 devadr;
+
+	if (miiphy_set_current_dev(name))
+		return;
+
+	/* command to read PHY dev address */
+	if (miiphy_read(name, 0xEE, 0xEE, (u16 *) &devadr)) {
+		printf("Err..%s could not read PHY dev address\n",
+			__FUNCTION__);
+		return;
+	}
+
+	/*
+	 * Enable RGMII delay on rx and tx clock
+	 * Ref: sec RGMII Pad Skew Registers of chip datasheet
+	 */
+	miiphy_write(name, devadr, KSZ9031RNX_MMD_CTRL_REG, 0x2);
+	miiphy_write(name, devadr, KSZ9031RNX_MMD_DATA_REG, 0x8);
+	miiphy_write(name, devadr, KSZ9031RNX_MMD_CTRL_REG, 0x4002);
+
+	miiphy_read(name,  devadr, KSZ9031RNX_MMD_DATA_REG, &reg);
+	miiphy_write(name, devadr, KSZ9031RNX_MMD_DATA_REG, reg | 0x3FF);
+
+	/* reset the phy */
+	miiphy_reset(name, devadr);
+
+	printf("KSZ9031RNX Initialized on %s\n", name);
+}
+
+void reset_phy(void)
+{
+	mv_phy_init("egiga0");
+
+	/* configure and initialize both PHY's */
+	mv_phy_init("egiga1");
+}
+#endif /* CONFIG_RESET_PHY_R */
diff --git a/configs/hikirk_defconfig b/configs/hikirk_defconfig
new file mode 100644
index 0000000..5644b83
--- /dev/null
+++ b/configs/hikirk_defconfig
@@ -0,0 +1,47 @@
+CONFIG_SYS_EXTRA_OPTIONS="BOARD_IS_HIKIRK"
+CONFIG_ARM=y
+CONFIG_KIRKWOOD=y
+CONFIG_TARGET_HIKIRK=y
+CONFIG_SYS_NO_FLASH=y
+CONFIG_SYS_MVFS=y
+CONFIG_CMD_DHCP=y
+CONFIG_CMD_ENV=y
+CONFIG_CMD_MII=y
+CONFIG_CMD_SPI=y
+CONFIG_CMD_SF=y
+CONFIG_CMD_PING=y
+CONFIG_CMD_USB=y
+CONFIG_CMD_IDE=y
+CONFIG_CMD_EXT4=y
+CONFIG_AUTOBOOT_KEYED=y
+CONFIG_AUTOBOOT_PROMPT="Press . to abort autoboot in %d seconds.\n"
+CONFIG_AUTOBOOT_STOP_STR="."
+CONFIG_SPI_FLASH=y
+CONFIG_SPI_FLASH_MTD=y
+CONFIG_CMD_BDI=y
+CONFIG_CMD_CONSOLE=y
+CONFIG_CMD_BOOTD=y
+CONFIG_CMD_RUN=y
+CONFIG_CMD_IMI=y
+CONFIG_CMD_XIMG=y
+CONFIG_CMD_EDITENV=y
+CONFIG_CMD_SAVEENV=y
+CONFIG_CMD_MEMORY=y
+CONFIG_CMD_LOADB=y
+CONFIG_CMD_LOADS=y
+CONFIG_CMD_ECHO=y
+CONFIG_CMD_ITEST=y
+CONFIG_CMD_SOURCE=y
+CONFIG_CMD_NET=y
+CONFIG_CMD_NFS=y
+CONFIG_CMD_MISC=y
+CONFIG_NET=y
+# CONFIG_NET_RANDOM_ETHADDR is not set
+# CONFIG_NETDEVICES is not set
+# CONFIG_CMD_ENV_EXISTS is not set
+# CONFIG_CMD_FLASH is not set
+# CONFIG_CMD_FPGA is not set
+# CONFIG_CMD_IMLS is not set
+# CONFIG_CMD_NAND is not set
+# CONFIG_CMD_SETEXPR is not set
+# CONFIG_EXPERT is not set
diff --git a/include/configs/hikirk.h b/include/configs/hikirk.h
new file mode 100644
index 0000000..658234d
--- /dev/null
+++ b/include/configs/hikirk.h
@@ -0,0 +1,156 @@
+/*
+ * Based on openrd.h:
+ * (C) Copyright 2009
+ * Net Insight <www.netinsight.net>
+ * Written-by: Simon Kagstrom <simon.kagstrom@netinsight.net>
+ *
+ * Based on sheevaplug.h:
+ * (C) Copyright 2009
+ * Marvell Semiconductor <www.marvell.com>
+ * Written-by: Prafulla Wadaskar <prafulla@marvell.com>
+ *
+ * See file CREDITS for list of people who contributed to this
+ * project.
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License as
+ * published by the Free Software Foundation; either version 2 of
+ * the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+ * MA 02110-1301 USA
+ */
+
+#ifndef _CONFIG_HIKIRK_H
+#define _CONFIG_HIKIRK_H
+
+/*
+ * Version number information
+ */
+#define CONFIG_IDENT_STRING	"\nhikirk"
+
+/*
+ * High Level Configuration Options (easy to change)
+ */
+#define CONFIG_SHEEVA_88SV131  1   /* CPU Core subversion */
+#define CONFIG_KIRKWOOD        1   /* SOC Family Name */
+#define CONFIG_KW88F6281       1   /* SOC Name */
+#define CONFIG_MACH_HIKIRK         /* Machine type */
+#define CONFIG_SKIP_LOWLEVEL_INIT  /* disable board lowlevel_init */
+
+/*
+ * Commands configuration
+ */
+#define CONFIG_SYS_NO_FLASH		/* Declare no flash (NOR/SPI) */
+#define CONFIG_SF_DEFAULT_SPEED  80000000
+#define CONFIG_ENV_SPI_MAX_HZ CONFIG_SF_DEFAULT_SPEED 
+
+/*
+ * mv-common.h should be defined after CMD configs since it used them
+ * to enable certain macros
+ */
+#include "mv-common.h"
+
+#undef CONFIG_SPI_FLASH_MACRONIX
+#define CONFIG_SPI_FLASH_MACRONIX
+#define CONFIG_SPI_FLASH_STMICRO
+/*
+ *  Environment variables configurations
+ */
+#ifdef CONFIG_CMD_NAND
+#define CONFIG_ENV_IS_IN_NAND		1
+#define CONFIG_ENV_SECT_SIZE		0x20000	/* 128K */
+/*
+ * max 4k env size is enough, but in case of nand
+ * it has to be rounded to sector size
+ */
+#define CONFIG_ENV_SIZE			0x20000	/* 128k */
+#define CONFIG_ENV_ADDR			0x60000
+#define CONFIG_ENV_OFFSET		0x60000	/* env starts here */
+#else
+#define CONFIG_ENV_IS_IN_SPI_FLASH
+#define CONFIG_SYS_REDUNDAND_ENVIRONMENT
+#define CONFIG_ENV_OFFSET       	0x1d0000
+#define CONFIG_ENV_OFFSET_REDUND	0x1e0000
+#define CONFIG_ENV_SIZE         	0x10000
+#define CONFIG_ENV_SIZE_REDUND		(CONFIG_ENV_SIZE)
+#define CONFIG_ENV_SECT_SIZE    	(CONFIG_ENV_SIZE)
+#endif
+
+/*
+ * auto boot
+ */
+#define CONFIG_AUTOBOOT_KEYED
+#define CONFIG_AUTOBOOT_STOP_STR "."
+#define CONFIG_ZERO_BOOTDELAY_CHECK
+#undef CONFIG_BOOTDELAY
+#define CONFIG_BOOTDELAY 0
+#define CONFIG_AUTOBOOT_PROMPT					\
+  "Press . to abort autoboot in %d seconds\n",bootdelay
+
+/*
+ * Default environment variables
+ */
+#define CONFIG_BOOTCOMMAND		"run x_bootA"
+
+#define CONFIG_EXTRA_ENV_SETTINGS	"boot_usb=usb start;"			\
+	"setenv bootargs console=ttyS0,115200 rw root=/dev/sda2 rootwait;"	\
+	"ext4load usb 0:2 0x2000000 /boot/uImage; ext4load usb 0:2 0x12000000 /boot/kirkwood-hikirk.dtb; bootm 0x2000000 - 0x12000000\0"			\
+	"boot_ide=ide reset; setenv bootargs console=ttyS0,115200 rw root=/dev/sda1 rootwait;"    \
+	"ext4load ide 0 0x2000000 /boot/uImage; ext4load ide 0 0x12000000 /boot/kirkwood-hikirk.dtb; bootm 0x2000000 - 0x12000000\0"	\
+	"x_bootargsA=console=ttyS0,115200 vmalloc=50M rw root=/dev/mmcblk0p1 rootflags=discard rootwait\0"	\
+	"x_bootargsB=console=ttyS0,115200 vmalloc=50M rw root=/dev/mmcblk0p2 rootflags=discard rootwait\0"	\
+	"x_kernelA=ext4load mmc 0:1 0x2000000 /boot/uImage\0"	\
+	"x_kernelB=ext4load mmc 0:2 0x2000000 /boot/uImage\0"	\
+	"x_dtA=ext4load mmc 0:1 0x12000000 /boot/kirkwood-hikirk.dtb\0"	\
+	"x_dtB=ext4load mmc 0:2 0x12000000 /boot/kirkwood-hikirk.dtb\0"	\
+	"x_bootA=${x_kernelA}; ${x_dtA}; setenv bootargs ${x_bootargsA}; bootm 0x2000000 - 0x12000000\0"	\
+	"x_bootB=${x_kernelB}; ${x_dtB}; setenv bootargs ${x_bootargsB}; bootm 0x2000000 - 0x12000000\0"
+
+#define CONFIG_OF_LIBFDT
+
+/*
+ * Ethernet Driver configuration
+ */
+#ifdef CONFIG_CMD_NET
+#define CONFIG_MVGBE_PORTS	{1, 1}	/* enable both ports */
+#define CONFIG_PHY_BASE_ADR	0x2
+#endif /* CONFIG_CMD_NET */
+
+/*
+ * SATA Driver configuration
+ */
+#ifdef CONFIG_MVSATA_IDE
+#define CONFIG_SYS_ATA_IDE0_OFFSET	MV_SATA_PORT0_OFFSET
+#define CONFIG_SYS_ATA_IDE1_OFFSET	MV_SATA_PORT1_OFFSET
+#endif /*CONFIG_MVSATA_IDE*/
+
+#define CONFIG_CMD_MMC
+#ifdef CONFIG_CMD_MMC
+#define CONFIG_MMC
+#define CONFIG_GENERIC_MMC
+#define CONFIG_MVEBU_MMC
+#define CONFIG_SYS_MMC_BASE KW_SDIO_BASE
+#endif /* CONFIG_CMD_MMC */
+
+/*
+ * Ext4 Access
+ */
+#define CONFIG_FS_EXT4
+#define CONFIG_CMD_EXT2
+#define CONFIG_CMD_EXT4
+#define CONFIG_CMD_FS_GENERIC
+
+/*
+ * FAT Access
+ */
+#define CONFIG_CMD_FAT
+
+#endif /* _CONFIG_HIKIRK_H */
-- 
2.7.0

