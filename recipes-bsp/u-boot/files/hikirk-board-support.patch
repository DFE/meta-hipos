From 478ebff1c68fbce7eb9c00799e09563da1c3bd3e Mon Sep 17 00:00:00 2001
From: Mario Schuknecht <mario.schuknecht@dresearch-fe.de>
Date: Thu, 12 Sep 2013 10:33:13 +0200
Subject: [PATCH] hikirk: add hikirk board

Add support for hikirk board.

Signed-off-by: Angelika Tobisch <tobisch@dresearch-fe.de>
Signed-off-by: Eik Binschek <binschek@dresearch-fe.de>
Signed-off-by: Mario Schuknecht <mario.schuknecht@dresearch-fe.de>
---
 board/Marvell/openrd/openrd.c |   69 +++++++++++++++++++++++++++++++++++++++--
 boards.cfg                    |    1 +
 include/configs/openrd.h      |   47 +++++++++++++++++++++++++---
 3 files changed, 109 insertions(+), 8 deletions(-)

diff --git a/board/Marvell/openrd/openrd.c b/board/Marvell/openrd/openrd.c
index c59a326..01962e0 100644
--- a/board/Marvell/openrd/openrd.c
+++ b/board/Marvell/openrd/openrd.c
@@ -49,26 +49,45 @@ int board_early_init_f(void)
 
 	/* Multi-Purpose Pins Functionality configuration */
 	static const u32 kwmpp_config[] = {
+#ifdef CONFIG_BOARD_IS_HIKIRK
+		MPP0_SPI_SCn,
+		MPP1_SPI_MOSI,
+		MPP2_SPI_SCK,
+		MPP3_SPI_MISO,
+		MPP4_UART0_RXD,
+		MPP5_UART0_TXD,
+#else
 		MPP0_NF_IO2,
 		MPP1_NF_IO3,
 		MPP2_NF_IO4,
 		MPP3_NF_IO5,
 		MPP4_NF_IO6,
 		MPP5_NF_IO7,
+#endif
 		MPP6_SYSRST_OUTn,
 		MPP7_GPO,
 		MPP8_TW_SDA,
 		MPP9_TW_SCK,
+#ifdef CONFIG_BOARD_IS_HIKIRK
+		MPP10_GPO,
+		MPP11_GPIO,
+#else
 		MPP10_UART0_TXD,
 		MPP11_UART0_RXD,
+#endif
 		MPP12_SD_CLK,
 		MPP13_SD_CMD, /* Alt UART1_TXD */
 		MPP14_SD_D0,  /* Alt UART1_RXD */
 		MPP15_SD_D1,
 		MPP16_SD_D2,
 		MPP17_SD_D3,
+#ifdef CONFIG_BOARD_IS_HIKIRK
+		MPP18_GPO,
+		MPP19_GPO,
+#else
 		MPP18_NF_IO0,
 		MPP19_NF_IO1,
+#endif
 		MPP20_GE1_0,
 		MPP21_GE1_1,
 		MPP22_GE1_2,
@@ -84,10 +103,17 @@ int board_early_init_f(void)
 		MPP32_GE1_12,
 		MPP33_GE1_13,
 		MPP34_GPIO,   /* UART1 / SD sel */
+#ifdef CONFIG_BOARD_IS_HIKIRK
+		MPP35_GPIO,
+		MPP36_GPIO,
+		MPP37_GPIO,
+		MPP38_GPIO,
+#else
 		MPP35_TDM_CH0_TX_QL,
 		MPP36_TDM_SPI_CS1,
 		MPP37_TDM_CH2_TX_QL,
 		MPP38_TDM_CH2_RX_QL,
+#endif
 		MPP39_AUDIO_I2SBCLK,
 		MPP40_AUDIO_I2SDO,
 		MPP41_AUDIO_I2SLRC,
@@ -115,7 +141,7 @@ int board_init(void)
 	gd->bd->bi_arch_number = MACH_TYPE_OPENRD_BASE;
 #elif defined(CONFIG_BOARD_IS_OPENRD_CLIENT)
 	gd->bd->bi_arch_number = MACH_TYPE_OPENRD_CLIENT;
-#elif defined(CONFIG_BOARD_IS_OPENRD_ULTIMATE)
+#elif defined(CONFIG_BOARD_IS_OPENRD_ULTIMATE) || defined(CONFIG_BOARD_IS_HIKIRK)
 	gd->bd->bi_arch_number = MACH_TYPE_OPENRD_ULTIMATE;
 #endif
 
@@ -125,6 +151,42 @@ int board_init(void)
 }
 
 #ifdef CONFIG_RESET_PHY_R
+#ifdef CONFIG_BOARD_IS_HIKIRK
+#define KSZ9031RNX_MMD_CTRL_REG 0xd
+#define KSZ9031RNX_MMD_DATA_REG 0xe
+/* Configure and enable MV88E1116/88E1121 PHY */
+void mv_phy_init(char *name)
+{
+	u16 reg;
+	u16 devadr;
+
+	if (miiphy_set_current_dev(name))
+		return;
+
+	/* command to read PHY dev address */
+	if (miiphy_read(name, 0xEE, 0xEE, (u16 *) &devadr)) {
+		printf("Err..%s could not read PHY dev address\n",
+			__FUNCTION__);
+		return;
+	}
+
+	/*
+	 * Enable RGMII delay on rx clock
+	 * Ref: sec RGMII Pad Skew Registers of chip datasheet
+	 */
+	miiphy_write(name, devadr, KSZ9031RNX_MMD_CTRL_REG, 0x2);
+	miiphy_write(name, devadr, KSZ9031RNX_MMD_DATA_REG, 0x8);
+	miiphy_write(name, devadr, KSZ9031RNX_MMD_CTRL_REG, 0x4002);
+
+	miiphy_read(name,  devadr, KSZ9031RNX_MMD_DATA_REG, &reg);
+	miiphy_write(name, devadr, KSZ9031RNX_MMD_DATA_REG, reg | 0x1F);
+
+	/* reset the phy */
+	miiphy_reset(name, devadr);
+
+	printf("KSZ9031RNX Initialized on %s\n", name);
+}
+#else
 /* Configure and enable MV88E1116/88E1121 PHY */
 void mv_phy_init(char *name)
 {
@@ -156,7 +218,7 @@ void mv_phy_init(char *name)
 
 	printf(PHY_NO" Initialized on %s\n", name);
 }
-
+#endif
 void reset_phy(void)
 {
 	mv_phy_init("egiga0");
@@ -169,7 +231,8 @@ void reset_phy(void)
 #endif
 
 #if defined(CONFIG_BOARD_IS_OPENRD_CLIENT) || \
-	defined(CONFIG_BOARD_IS_OPENRD_ULTIMATE)
+	defined(CONFIG_BOARD_IS_OPENRD_ULTIMATE) || \
+	defined(CONFIG_BOARD_IS_HIKIRK)
 	/* configure and initialize both PHY's */
 	mv_phy_init("egiga1");
 #endif
diff --git a/boards.cfg b/boards.cfg
index e4b0d44..ea83a5d 100644
--- a/boards.cfg
+++ b/boards.cfg
@@ -176,6 +176,7 @@ wireless_space               arm         arm926ejs   wireless_space      LaCie
 dreamplug                    arm         arm926ejs   -                   Marvell        kirkwood
 guruplug                     arm         arm926ejs   -                   Marvell        kirkwood
 mv88f6281gtw_ge              arm         arm926ejs   -                   Marvell        kirkwood
+hikirk                       arm         arm926ejs   openrd              Marvell        kirkwood        openrd:BOARD_IS_HIKIRK
 openrd_base                  arm         arm926ejs   openrd              Marvell        kirkwood        openrd:BOARD_IS_OPENRD_BASE
 openrd_client                arm         arm926ejs   openrd              Marvell        kirkwood        openrd:BOARD_IS_OPENRD_CLIENT
 openrd_ultimate              arm         arm926ejs   openrd              Marvell        kirkwood        openrd:BOARD_IS_OPENRD_ULTIMATE
diff --git a/include/configs/openrd.h b/include/configs/openrd.h
index 53bafe1..6ef484b 100644
--- a/include/configs/openrd.h
+++ b/include/configs/openrd.h
@@ -33,6 +33,9 @@
 /*
  * Version number information
  */
+#ifdef CONFIG_BOARD_IS_HIKIRK
+# define CONFIG_IDENT_STRING	"\nhikirk"
+#else
 #ifdef CONFIG_BOARD_IS_OPENRD_ULTIMATE
 # define CONFIG_IDENT_STRING	"\nOpenRD-Ultimate"
 #else
@@ -46,6 +49,7 @@
 #  endif
 # endif
 #endif
+#endif
 
 /*
  * High Level Configuration Options (easy to change)
@@ -65,7 +69,16 @@
 #define CONFIG_CMD_DHCP
 #define CONFIG_CMD_ENV
 #define CONFIG_CMD_MII
+#ifdef CONFIG_BOARD_IS_HIKIRK
+#define CONFIG_SPI_FLASH_MACRONIX
+#define CONFIG_SPI_FLASH_STMICRO
+#define CONFIG_CMD_SPI
+#define CONFIG_CMD_SF
+#define CONFIG_SF_DEFAULT_SPEED  80000000
+#define CONFIG_ENV_SPI_MAX_HZ CONFIG_SF_DEFAULT_SPEED 
+#else
 #define CONFIG_CMD_NAND
+#endif
 #define CONFIG_CMD_PING
 #define CONFIG_CMD_USB
 #define CONFIG_CMD_IDE
@@ -82,9 +95,6 @@
 #ifdef CONFIG_CMD_NAND
 #define CONFIG_ENV_IS_IN_NAND		1
 #define CONFIG_ENV_SECT_SIZE		0x20000	/* 128K */
-#else
-#define CONFIG_ENV_IS_NOWHERE		1	/* if env in SDRAM */
-#endif
 /*
  * max 4k env size is enough, but in case of nand
  * it has to be rounded to sector size
@@ -92,10 +102,32 @@
 #define CONFIG_ENV_SIZE			0x20000	/* 128k */
 #define CONFIG_ENV_ADDR			0x60000
 #define CONFIG_ENV_OFFSET		0x60000	/* env starts here */
+#else
+#define CONFIG_ENV_IS_IN_SPI_FLASH
+#define CONFIG_SYS_REDUNDAND_ENVIRONMENT
+#define CONFIG_ENV_OFFSET       	0x1d0000
+#define CONFIG_ENV_OFFSET_REDUND	0x1e0000
+#define CONFIG_ENV_SIZE         	0x10000
+#define CONFIG_ENV_SIZE_REDUND		(CONFIG_ENV_SIZE)
+#define CONFIG_ENV_SECT_SIZE    	(CONFIG_ENV_SIZE)
+#endif
 
 /*
  * Default environment variables
  */
+#ifdef CONFIG_BOARD_IS_HIKIRK
+#define CONFIG_BOOTCOMMAND		"run x_bootA"
+
+#define CONFIG_EXTRA_ENV_SETTINGS	"boot_usb=usb start;"			\
+	"setenv bootargs 'console=ttyS0,115200 rw root=/dev/sda2 rootwait ethaddr=${ethaddr} eth1addr=${eth1addr}';"	\
+	"fatload usb 0 0x2000000 uImage;bootm 0x2000000\0"			\
+	"x_bootargsA=console=ttyS0,115200 vmalloc=50M rw root=/dev/mmcblk0p1 rootflags=discard rootwait\0"	\
+	"x_bootargsB=console=ttyS0,115200 vmalloc=50M rw root=/dev/mmcblk0p2 rootflags=discard rootwait\0"	\
+	"x_kernelA=sf read 0x2000000 0x200000 0x700000\0"	\
+	"x_kernelB=sf read 0x2000000 0x900000 0x700000\0"	\
+	"x_bootA=sf probe; ${x_kernelA}; setenv bootargs ${x_bootargsA} ethaddr=${ethaddr} eth1addr=${eth1addr} ${x_infoA}; bootm 0x2000000\0"	\
+	"x_bootB=sf probe; ${x_kernelB}; setenv bootargs ${x_bootargsB} ethaddr=${ethaddr} eth1addr=${eth1addr} ${x_infoB}; bootm 0x2000000\0"
+#else
 #define CONFIG_BOOTCOMMAND		"${x_bootcmd_kernel}; "	\
 	"setenv bootargs ${x_bootargs} ${x_bootargs_root}; "	\
 	"${x_bootcmd_usb}; bootm 0x6400000;"
@@ -112,6 +144,7 @@
 	"x_bootargs_root=root=ubi0:rootfs rootfstype=ubifs\0"		\
 	"mtdids="MTDIDS_DEFAULT"\0"					\
 	"mtdparts="MTDPARTS_DEFAULT"\0"
+#endif
 
 /*
  * Ethernet Driver configuration
@@ -126,8 +159,12 @@
 #  define CONFIG_PHY_BASE_ADR	0x0
 #  define PHY_NO		"88E1121"
 # else
-#  define CONFIG_PHY_BASE_ADR	0x8
-#  define PHY_NO		"88E1116"
+#  ifdef CONFIG_BOARD_IS_HIKIRK
+#   define CONFIG_PHY_BASE_ADR	0x0
+#  else
+#   define CONFIG_PHY_BASE_ADR	0x8
+#   define PHY_NO		"88E1116"
+#  endif
 # endif
 #endif /* CONFIG_CMD_NET */
 
-- 
1.7.9.5

